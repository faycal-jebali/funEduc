<div class="section-exercice-container">
  <pre>{{ form.errors | json }}</pre>
  <h1 *ngIf="!isEditing">Créer une Section et ses Exercices</h1>
  <h1 *ngIf="isEditing">Modifier une Section et ses Exercices</h1>
  <form [formGroup]="form" (ngSubmit)="submit()">
    <!-- Formulaire de la section -->
    <h2 class="primary-color">Section</h2>
    <div formGroupName="section" class="grid-form">
      <mat-form-field appearance="fill">
        <mat-label>Titre de la Section :</mat-label>
        <input matInput formControlName="title" type="text" />
        <mat-error
          *ngIf="
            form.get('section.title')?.invalid &&
            form.get('section.title')?.touched
          "
        >
          Le titre est requis.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Classes :</mat-label>
        <mat-select formControlName="class_id">
          <mat-option *ngFor="let course of courses" [value]="course.id">
            {{ course.title }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Leçon :</mat-label>
        <mat-select formControlName="lesson_id">
          <mat-option
            *ngFor="let lesson of selectedClass?.children"
            [value]="lesson.id"
          >
            {{ lesson.title }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Catégorie :</mat-label>
        <mat-select formControlName="category_id">
          <mat-option
            *ngFor="let category of selectedCourse?.children"
            [value]="category.id"
          >
            {{ category.title }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Sous-Leçon :</mat-label>
        <mat-select formControlName="subLesson_id">
          <mat-option
            *ngFor="let subLesson of selectedCategory?.children"
            [value]="subLesson.id"
          >
            {{ subLesson.title }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-error
        *ngIf="
          form.get('section.lesson')?.invalid &&
          form.get('section.lesson')?.touched
        "
      >
        La leçon est requise.
      </mat-error>

      <mat-form-field appearance="fill">
        <mat-label>Description :</mat-label>
        <textarea matInput formControlName="description"></textarea>
      </mat-form-field>
    </div>

    <!-- Liste des exercices -->
    <div formArrayName="exercices">
      <h2 class="primary-color">Exercices</h2>
      <div
        *ngFor="let exercice of exercices.controls; let i = index"
        [formGroupName]="i"
        class="box-border-radius"
      >
        <h3 class="box-exercice-form">
          <span class="item-numero">{{ i + 1 }}</span> Exercice
          <button mat-icon-button (click)="removeExercice(i)">
            <mat-icon>delete</mat-icon>
          </button>
        </h3>
        <div class="grid-form">
          <mat-form-field appearance="fill">
            <mat-label>Type :</mat-label>
            <mat-select id="type-{{ i }}" formControlName="type">
              <mat-option value="fill-in-the-blank"
                >Compléter les blancs</mat-option
              >
              <mat-option value="multiple-choice">Choix multiples</mat-option>
              <!--TODO-->
              <!--mat-option value="matching">Matching</mat-option-->
              <mat-option value="dictation">Dictée</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Consigne :</mat-label>
            <input
              matInput
              id="consigne-{{ i }}"
              formControlName="consigne"
              type="text"
            />
          </mat-form-field>
          <mat-form-field appearance="fill">
            <mat-label>Question :</mat-label>
            <input
              matInput
              id="question-{{ i }}"
              formControlName="question"
              type="text"
            />
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Réponse Correcte :</mat-label>
            <input
              matInput
              id="correct_answer-{{ i }}"
              formControlName="correct_answer"
              type="text"
            />
          </mat-form-field>

          <!-- Gestion des options pour choix multiple -->
          <div
            *ngIf="
              ['multiple-choice', 'matching'].includes(
                exercice.get('type')?.value
              )
            "
          >
            <mat-label>Options :</mat-label>
            <div formArrayName="options">
              <div *ngFor="let option of getOptions(i).controls; let j = index">
                <mat-form-field appearance="fill">
                  <input matInput [formControlName]="j" type="text" />
                </mat-form-field>
                <button mat-icon-button (click)="removeOption(i, j)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
            <button
              mat-raised-button
              color="primary"
              type="button"
              (click)="addOption(i)"
            >
              Ajouter une option
            </button>
          </div>

          <mat-form-field appearance="fill">
            <mat-label>Difficulté :</mat-label>
            <mat-select id="difficulty-{{ i }}" formControlName="difficulty">
              <mat-option value="easy">Facile</mat-option>
              <mat-option value="medium">Moyenne</mat-option>
              <mat-option value="hard">Difficile</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Explication :</mat-label>
            <textarea
              matInput
              id="explanation-{{ i }}"
              formControlName="explanation"
            ></textarea>
          </mat-form-field>
        </div>
      </div>
    </div>
    <div>
      <button
        mat-raised-button
        color="primary"
        type="button"
        (click)="addExercice()"
      >
        Ajouter un Exercice
      </button>
      <br /><br />
    </div>
    <div>
      <button mat-raised-button color="accent" type="submit">
        Enregistrer
      </button>
    </div>
  </form>
</div>
